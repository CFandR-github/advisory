<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=utf-8"/>
	<title></title>
	<meta name="generator" content="LibreOffice 6.4.7.2 (Linux)"/>
	<meta name="created" content="2022-05-24T11:48:40.183473832"/>
	<meta name="changed" content="2022-05-24T18:22:56.858866117"/>
	<style type="text/css">
		@page { size: 8.27in 11.69in; margin: 0.79in }
		p { margin-bottom: 0.1in; line-height: 115%; background: transparent }
		strong { font-weight: bold }
	</style>
</head>
<body lang="en-US" link="#000080" vlink="#800000" dir="ltr"><p align="center" style="margin-bottom: 0in; line-height: 100%">
<b>phpmailer + swiftmailer 0day unserialize RCE</b></p>
<p align="center" style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p align="left" style="margin-bottom: 0in; font-weight: normal; line-height: 100%">
Requirements:</p>
<ul>
	<li><p align="left" style="margin-bottom: 0in; font-weight: normal; line-height: 100%">
	Any PHP version</p>
	<li><p align="left" style="margin-bottom: 0in; font-weight: normal; line-height: 100%">
	Any phpmailer/phpmailer version</p>
	<li><p align="left" style="margin-bottom: 0in; font-weight: normal; line-height: 100%">
	swiftmailer/swiftmailer &lt;= 6.2.4</p>
</ul>
<p align="left" style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">This advisory
demonstrates another usage of reference (R:) serialization and fast
“__destruct” call in PHP unserialize exploits. PHPMailer has some
interesting code <span lang="en-US">reachable from __</span><span lang="en-US">destruct.
But c</span>ode needs to pass <b>is_resource($this-&gt;smtp_conn)</b>
condition. Resource type can’t be serialized in PHP. The idea is to
create resource <span lang="en-US">during unserialization process and
use reference to resource.</span></p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><span lang="en-US">I</span><span lang="en-US">nstall
software:</span></p>
<p align="left" style="margin-bottom: 0in; font-weight: normal; line-height: 100%">
$ cat composer.json</p>
<p style="margin-bottom: 0in; line-height: 100%">{</p>
<p style="margin-bottom: 0in; line-height: 100%">    &quot;require&quot;:
{</p>
<p style="margin-bottom: 0in; line-height: 100%">       
&quot;phpmailer/phpmailer&quot;: &quot;6.6.0&quot;,</p>
<p style="margin-bottom: 0in; line-height: 100%">       
&quot;swiftmailer/swiftmailer&quot; : &quot;6.2.4&quot;</p>
<p style="margin-bottom: 0in; line-height: 100%">    }</p>
<p style="margin-bottom: 0in; line-height: 100%">}</p>
<p style="margin-bottom: 0in; line-height: 100%">$ composer install</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">1) Create resource
with Swiftmailer. Start from __destruct.</p>
<p style="margin-bottom: 0in; line-height: 100%">File
swiftmailer/swiftmailer/lib/classes/Swift/Transport/AbstractSmtpTransport.php:</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_2270caefe4211aa5.png" name="Image1" align="left" width="396" height="195" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_5a83af6c74ccd143.png" name="Image2" align="left" width="605" height="300" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">File
swiftmailer/swiftmailer/lib/classes/Swift/ByteStream/FileByteStream.php:</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_87d0f60dab07cdba.png" name="Image4" align="left" width="503" height="104" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_82efcdc1f28d4e1e.png" name="Image3" align="left" width="643" height="184" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">$this→writer is
set to resource on line 147.  $this→reader property is PHPMailer
object in serialized string.</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_2fa2985872d95ccb.png" name="Image6" align="left" width="508" height="128" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">fclose call on line
159 with object argument makes only Warning message, execution
continues.</p>
<p style="margin-bottom: 0in; line-height: 100%">On line 160
$this→reader property is assigned to null. It leads to immediate
__destruct call.</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">2) Call __destruct
of PHPMailer object</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><strong><span style="font-weight: normal">File
phpmailer/phpmailer/src/PHPMailer.php:</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_1b7bcd126d144ed3.png" name="Image5" align="left" width="506" height="134" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_7424093bf4a5dec4.png" name="Image7" align="left" width="643" height="143" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">File
phpmailer/phpmailer/src/SMTP.php:</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_6aaad81560a0eee8.png" name="Image8" align="left" width="643" height="169" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">$this→smtp_conn is
reference to $this→writer property in serialized string.
$this→writer is set to resource, and condition on line 658 passes.
Return <b>true</b> from “connected” method and call “edebug”
method.</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_d1abe01062b81bd3.png" name="Image10" align="left" width="643" height="226" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%">Execute method of
any object using <strong>call_user_func. </strong><strong><span style="font-weight: normal">Set
$this→Debugoutput with array</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><strong><span style="font-weight: normal">s:11:&quot;Debugoutput&quot;;a:2:{i:0;O:29:&quot;PHPMailer\PHPMailer\PHPMailer&quot;:2:{s:6:&quot;Mailer&quot;;s:8:&quot;sendmail&quot;;s:8:&quot;Sendmail&quot;;s:22:&quot;/bin/sh
-c &quot;uname -sp&quot;&quot;;}i:1;s:8:&quot;postSend&quot;;}}}</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><strong><span style="font-weight: normal">Execute
</span></strong><strong><span style="font-weight: normal">postSend
</span></strong><strong><span style="font-weight: normal">method.
File phpmailer/phpmailer/src/PHPMailer.php:</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_c719b43ded18974e.png" name="Image11" align="left" width="643" height="109" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><strong><span style="font-weight: normal">Call
popen to get code execution in sendmailSend method:</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_a6057fd7d6a949ab.png" name="Image9" align="left" width="643" height="109" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><img src="./images/phpmailer_unserialize_rce_0day_html_475e2fc5d3ed88e6.png" name="Image12" align="left" width="527" height="111" border="0"/>
<br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
<p style="margin-bottom: 0in; line-height: 100%"><strong><span style="font-weight: normal">Exploit
POC can be found here.</span></strong></p>
<p style="margin-bottom: 0in; line-height: 100%"><br/>

</p>
</body>
</html>